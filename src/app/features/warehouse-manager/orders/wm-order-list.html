<div class="wm-order-list">
  <div class="page-header">
    <h2>Commandes</h2>
    <p class="subtitle">Commandes de votre entrepôt et commandes non assignées. Assignez un entrepôt puis réservez le stock.</p>
  </div>

  @if (noWarehouse) {
    <div class="alert alert-warn">
      <p>Assignez un entrepot a votre profil pour voir les commandes.</p>
      <a routerLink="/warehouse/profile" class="btn-link">Aller au profil</a>
    </div>
  } @else {
    <div class="toolbar">
      <div class="filters">
        <label for="status">Statut</label>
        <select id="status" [(ngModel)]="statusFilter" (change)="applyFilters()" class="select">
          <option value="">Tous</option>
          @for (s of statuses; track s) {
            <option [value]="s">{{ s }}</option>
          }
        </select>
      </div>
      <button type="button" class="btn btn-primary" (click)="applyFilters()">Filtrer</button>
    </div>

    @if (isLoading) {
      <div class="loading">
        <p>Chargement des commandes…</p>
      </div>
    } @else if (loadError) {
      <div class="load-error">
        <p>{{ loadError }}</p>
        <button type="button" class="btn btn-primary" (click)="loadWarehouseThenOrders()">Reessayer</button>
      </div>
    } @else {
      <div class="table-container">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Id</th>
              <th>Client</th>
              <th>Entrepot</th>
              <th>Statut</th>
              <th>Creee le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (o of orders; track o.id) {
              <tr>
                <td><span class="mono">#{{ o.id }}</span></td>
                <td>Client #{{ o.clientId }}</td>
                <td>
                  @if (o.warehouseName) {
                    {{ o.warehouseName }}
                  } @else {
                    <span class="unassigned">Non assigné</span>
                  }
                </td>
                <td><span class="badge" [class]="'badge-' + (o.status | lowercase)">{{ o.status }}</span></td>
                <td>{{ formatDate(o.createdAt) }}</td>
                <td class="actions">
                  @if (canAssign(o)) {
                    <div class="assign-row">
                      <select class="select select-sm" [ngModel]="selectedWarehouseByOrderId[o.id]" (ngModelChange)="selectedWarehouseByOrderId[o.id] = $event">
                        <option [ngValue]="null">Choisir entrepôt</option>
                        @for (w of warehouses; track w.id) {
                          <option [ngValue]="w.id">{{ w.name }} ({{ w.code }})</option>
                        }
                      </select>
                      <button type="button" class="btn btn-assign" [disabled]="assigningId === o.id || !selectedWarehouseByOrderId[o.id]" (click)="assignWarehouse(o.id)">
                        {{ assigningId === o.id ? '…' : 'Assigner' }}
                      </button>
                    </div>
                  } @else if (canReserve(o)) {
                    <button type="button" class="btn btn-reserve" [disabled]="reservingId === o.id" (click)="reserve(o.id)">
                      {{ reservingId === o.id ? '…' : 'Réserver' }}
                    </button>
                  } @else {
                    <span class="muted">–</span>
                  }
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="empty">Aucune commande</td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      @if (totalPages > 1) {
        <div class="pagination">
          <button type="button" class="btn btn-sm" [disabled]="page === 0" (click)="goPage(page - 1)">Prec.</button>
          <span class="page-info">Page {{ page + 1 }} / {{ totalPages }} ({{ totalElements }} au total)</span>
          <button type="button" class="btn btn-sm" [disabled]="page >= totalPages - 1" (click)="goPage(page + 1)">Suiv.</button>
        </div>
      }
    }
  }
</div>
